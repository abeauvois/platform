# CI/CD Pipeline for Bun-based TypeScript Monorepo
# Runs on all PRs and pushes to main/develop branches

name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  BUN_VERSION: '1.3.5'

jobs:
  # Code quality checks
  quality:
    name: Code Quality
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Cache bun install cache
        uses: actions/cache@v5
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-cache-${{ hashFiles('**/bun.lock') }}

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build packages first (required for type checking)
        run: bun run build:lib

      - name: Type checking (packages and apps)
        run: bun run ci:typecheck

      - name: Lint dashboard
        working-directory: apps/dashboard
        run: bun run lint

  # Unit tests
  test-unit:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: quality
    steps:
      - uses: actions/checkout@v6

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Cache bun install cache
        uses: actions/cache@v5
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-cache-${{ hashFiles('**/bun.lock') }}

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Run unit tests
        run: bun run test:unit

      - name: Run package tests
        run: |
          cd packages/platform-sdk && bun test ./tests/unit || true
          cd ../platform-utils && bun test || true

  # Build verification
  build:
    name: Build
    runs-on: ubuntu-latest
    needs: quality
    strategy:
      matrix:
        include:
          - name: api
            path: apps/api
          - name: dashboard
            path: apps/dashboard
          - name: cli
            path: apps/cli
          - name: packages
            path: .
            script: build
    steps:
      - uses: actions/checkout@v6

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Cache bun install cache
        uses: actions/cache@v5
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-cache-${{ hashFiles('**/bun.lock') }}

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build packages first (required by apps)
        if: matrix.path != '.'
        run: bun run build:lib

      - name: Build ${{ matrix.name }}
        run: |
          if [ "${{ matrix.path }}" = "." ]; then
            bun run ${{ matrix.script || 'build' }}
          else
            cd ${{ matrix.path }} && bun run build
          fi

      - name: Upload build artifacts
        if: matrix.name != 'packages'
        uses: actions/upload-artifact@v6
        with:
          name: build-${{ matrix.name }}
          path: |
            ${{ matrix.path }}/dist
            ${{ matrix.path }}/.next
          retention-days: 7
          if-no-files-found: ignore

  # Docker build verification
  docker:
    name: Docker Build
    runs-on: ubuntu-latest
    needs: [test-unit, build]
    if: github.event_name == 'push' || github.event.pull_request.draft == false
    strategy:
      matrix:
        app: [api]
    steps:
      - uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v6
        with:
          context: ${{ github.workspace }}
          file: ${{ github.workspace }}/apps/${{ matrix.app }}/Dockerfile
          push: false
          tags: platform-${{ matrix.app }}:${{ github.sha }}
          no-cache: true
          build-args: |
            BUILD_DATE=${{ github.event.head_commit.timestamp }}
            VCS_REF=${{ github.sha }}

  # Integration tests (only on main branch or when explicitly requested)
  test-integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' || contains(github.event.pull_request.labels.*.name, 'run-integration-tests')
    services:
      postgres:
        image: postgres:17.5
        env:
          POSTGRES_USER: platform
          POSTGRES_PASSWORD: platform
          POSTGRES_DB: platform
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    steps:
      - uses: actions/checkout@v6

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Cache bun install cache
        uses: actions/cache@v5
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-cache-${{ hashFiles('**/bun.lock') }}

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Run database migrations
        env:
          DATABASE_URL: postgresql://platform:platform@localhost:5432/platform
        run: bun run db:migrate

      - name: Run integration tests
        env:
          DATABASE_URL: postgresql://platform:platform@localhost:5432/platform
          NODE_ENV: test
        run: |
          cd packages/platform-sdk && bun test ./tests/integration || true

  # E2E tests
  test-e2e:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' || contains(github.event.pull_request.labels.*.name, 'run-e2e-tests')
    services:
      postgres:
        image: postgres:17.5
        env:
          POSTGRES_USER: platform
          POSTGRES_PASSWORD: platform
          POSTGRES_DB: platform
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    steps:
      - uses: actions/checkout@v6

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Cache bun install cache
        uses: actions/cache@v5
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-cache-${{ hashFiles('**/bun.lock') }}

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Run database migrations
        env:
          DATABASE_URL: postgresql://platform:platform@localhost:5432/platform
        run: bun run db:migrate

      - name: Run E2E tests
        env:
          DATABASE_URL: postgresql://platform:platform@localhost:5432/platform
          NODE_ENV: test
        run: bun run test:e2e

  # Summary job for branch protection
  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs: [quality, test-unit, build, docker]
    if: always()
    steps:
      - name: Check all jobs
        run: |
          if [[ "${{ needs.quality.result }}" == "failure" ]] || \
             [[ "${{ needs.test-unit.result }}" == "failure" ]] || \
             [[ "${{ needs.build.result }}" == "failure" ]] || \
             [[ "${{ needs.docker.result }}" == "failure" ]]; then
            echo "One or more jobs failed"
            exit 1
          fi
          echo "All required jobs passed!"
