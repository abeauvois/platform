# Deployment workflow for Railway
# Deploys apps on release or manual trigger

name: Deploy

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      app:
        description: "App to deploy"
        required: true
        default: "trading"
        type: choice
        options:
          - trading
          - api
      environment:
        description: "Environment to deploy to"
        required: true
        default: "staging"
        type: choice
        options:
          - staging
          - production

env:
  BUN_VERSION: "1.3.5"
  RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}?

jobs:
  # Determine deployment parameters
  setup:
    name: Setup Deployment
    runs-on: ubuntu-latest
    outputs:
      app: ${{ steps.params.outputs.app }}
      environment: ${{ steps.params.outputs.environment }}
      service_id: ${{ steps.params.outputs.service_id }}
    steps:
      - name: Set deployment parameters
        id: params
        env:
          EVENT_NAME: ${{ github.event_name }}
          INPUT_APP: ${{ inputs.app }}
          INPUT_ENV: ${{ inputs.environment }}
          TRADING_PROD_SERVICE_ID: ${{ secrets.RAILWAY_TRADING_PROD_SERVICE_ID }}
          TRADING_STAGING_SERVICE_ID: ${{ secrets.RAILWAY_TRADING_STAGING_SERVICE_ID }}
          API_PROD_SERVICE_ID: ${{ secrets.RAILWAY_API_PROD_SERVICE_ID }}
          API_STAGING_SERVICE_ID: ${{ secrets.RAILWAY_API_STAGING_SERVICE_ID }}
        run: |
          if [[ "$EVENT_NAME" == "release" ]]; then
            echo "app=trading" >> $GITHUB_OUTPUT
            echo "environment=production" >> $GITHUB_OUTPUT
            echo "service_id=$TRADING_PROD_SERVICE_ID" >> $GITHUB_OUTPUT
          else
            echo "app=$INPUT_APP" >> $GITHUB_OUTPUT
            echo "environment=$INPUT_ENV" >> $GITHUB_OUTPUT

            # Map app + environment to Railway service IDs
            if [[ "$INPUT_APP" == "trading" && "$INPUT_ENV" == "staging" ]]; then
              echo "service_id=$TRADING_STAGING_SERVICE_ID" >> $GITHUB_OUTPUT
            elif [[ "$INPUT_APP" == "trading" && "$INPUT_ENV" == "production" ]]; then
              echo "service_id=$TRADING_PROD_SERVICE_ID" >> $GITHUB_OUTPUT
            elif [[ "$INPUT_APP" == "api" && "$INPUT_ENV" == "staging" ]]; then
              echo "service_id=$API_STAGING_SERVICE_ID" >> $GITHUB_OUTPUT
            elif [[ "$INPUT_APP" == "api" && "$INPUT_ENV" == "production" ]]; then
              echo "service_id=$API_PROD_SERVICE_ID" >> $GITHUB_OUTPUT
            fi
          fi

  # Deploy to Railway
  deploy:
    name: Deploy to Railway
    runs-on: ubuntu-latest
    needs: setup
    environment:
      name: ${{ needs.setup.outputs.environment }}
      url: ${{ steps.deploy.outputs.url }}
    steps:
      - uses: actions/checkout@v6

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Install Railway CLI
        run: |
          curl -fsSL https://railway.app/install.sh | sh
          echo "$HOME/.railway/bin" >> $GITHUB_PATH

      - name: Deploy ${{ needs.setup.outputs.app }} to ${{ needs.setup.outputs.environment }}
        id: deploy
        working-directory: apps/${{ needs.setup.outputs.app }}
        run: |
          # Deploy using Railway CLI
          railway up --service ${{ needs.setup.outputs.service_id }} --detach

          # Wait for deployment to complete
          echo "Waiting for deployment to complete..."
          sleep 30

          # Get deployment URL from Railway
          DOMAIN=$(railway domain --service ${{ needs.setup.outputs.service_id }} 2>/dev/null || echo "")
          if [[ -n "$DOMAIN" ]]; then
            echo "url=https://$DOMAIN" >> $GITHUB_OUTPUT
          else
            # Fallback to default Railway domain pattern
            echo "url=https://${{ needs.setup.outputs.app }}-${{ needs.setup.outputs.environment }}.up.railway.app" >> $GITHUB_OUTPUT
          fi

      - name: Run smoke tests
        env:
          DEPLOY_URL: ${{ steps.deploy.outputs.url }}
        run: |
          echo "Running smoke tests against $DEPLOY_URL"

          # Wait for service to be ready
          MAX_ATTEMPTS=10
          ATTEMPT=0

          while [[ $ATTEMPT -lt $MAX_ATTEMPTS ]]; do
            HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$DEPLOY_URL/health" --max-time 10 || echo "000")

            if [[ "$HTTP_STATUS" == "200" ]]; then
              echo "Health check passed!"
              exit 0
            fi

            echo "Attempt $((ATTEMPT + 1))/$MAX_ATTEMPTS: Status $HTTP_STATUS, waiting..."
            ATTEMPT=$((ATTEMPT + 1))
            sleep 10
          done

          echo "Health check failed after $MAX_ATTEMPTS attempts"
          exit 1

      - name: Notify deployment success
        if: success()
        run: |
          echo "::notice::Successfully deployed ${{ needs.setup.outputs.app }} to ${{ needs.setup.outputs.environment }}"
          echo "URL: ${{ steps.deploy.outputs.url }}"

      - name: Notify deployment failure
        if: failure()
        run: |
          echo "::error::Failed to deploy ${{ needs.setup.outputs.app }} to ${{ needs.setup.outputs.environment }}"

  # Rollback on failure (production only)
  rollback:
    name: Rollback
    runs-on: ubuntu-latest
    needs: [setup, deploy]
    if: failure() && needs.setup.outputs.environment == 'production'
    steps:
      - name: Install Railway CLI
        run: |
          curl -fsSL https://railway.app/install.sh | sh
          echo "$HOME/.railway/bin" >> $GITHUB_PATH

      - name: Rollback deployment
        run: |
          echo "Rolling back ${{ needs.setup.outputs.app }}"
          # Railway automatically keeps previous deployments
          # Use railway rollback or redeploy previous version
          railway rollback --service ${{ needs.setup.outputs.service_id }} || {
            echo "::warning::Auto-rollback not available. Please rollback manually from Railway dashboard."
          }
